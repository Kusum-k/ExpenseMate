<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ExpenseMate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
        }
        .badge-card {
            background: linear-gradient(45deg, #ffd700, #ffb347);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            margin: 0.5rem;
        }
        .progress-ring {
            width: 120px;
            height: 120px;
        }
        .sidebar {
            background: #f8f9fa;
            min-height: 100vh;
            padding-top: 1rem;
        }
        .nav-link {
            color: #495057;
            border-radius: 10px;
            margin: 0.2rem 0;
        }
        .nav-link:hover, .nav-link.active {
            background: #e9ecef;
            color: #495057;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="d-flex flex-column">
                    <a href="/" class="navbar-brand fw-bold mb-4 text-center">
                        <i class="fas fa-chart-line me-2"></i>ExpenseMate
                    </a>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="/user/dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                        <a class="nav-link" href="/user/expenses">
                            <i class="fas fa-receipt me-2"></i>Expenses
                        </a>
                        <a class="nav-link" href="/user/budgets">
                            <i class="fas fa-piggy-bank me-2"></i>Budgets
                        </a>
                        <a class="nav-link" href="/user/badges">
                            <i class="fas fa-trophy me-2"></i>Badges
                        </a>
                        <a class="nav-link" href="/user/reports">
                            <i class="fas fa-chart-bar me-2"></i>Reports
                        </a>
                        <a class="nav-link" href="/user/profile">
                            <i class="fas fa-user me-2"></i>Profile
                        </a>
                        <hr>
                        <a class="nav-link" href="/logout">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </nav>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="container-fluid py-4">
                    <!-- Header -->
                    <div class="row mb-4">
                        <div class="col">
                            <h1 class="h3 mb-0">
                                Welcome back, <span th:text="${user.fullName}">User</span>! ðŸ‘‹
                            </h1>
                            <p class="text-muted">Here's your financial overview for this month</p>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">This Month</h6>
                                        <h3 class="mb-0" th:text="'â‚¹' + ${currentMonthTotal}">â‚¹0</h3>
                                    </div>
                                    <i class="fas fa-wallet fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Budget Status</h6>
                                        <h3 class="mb-0" th:text="${currentBudget != null ? currentBudget.budgetStatus : 'No Budget'}">Safe</h3>
                                    </div>
                                    <i class="fas fa-piggy-bank fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); color: #333;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Total Badges</h6>
                                        <h3 class="mb-0" th:text="${totalBadges}">0</h3>
                                    </div>
                                    <i class="fas fa-trophy fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Points</h6>
                                        <h3 class="mb-0" th:text="${totalPoints}">0</h3>
                                    </div>
                                    <i class="fas fa-star fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Budget Progress -->
                    <div class="row mb-4" th:if="${currentBudget != null}">
                        <div class="col-12">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-chart-line me-2"></i>Budget Progress
                                    </h5>
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Spent: <span th:text="${currentBudget.formattedSpentAmount}">â‚¹0</span></span>
                                                <span>Budget: <span th:text="${currentBudget.formattedBudgetAmount}">â‚¹0</span></span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" 
                                                     th:style="'width: ' + ${currentBudget.spentPercentage} + '%; background-color: ' + ${currentBudget.budgetStatusColor}"
                                                     th:text="${#numbers.formatDecimal(currentBudget.spentPercentage, 1, 1)} + '%'">
                                                </div>
                                            </div>
                                            <small class="text-muted mt-1">
                                                Remaining: <span th:text="${currentBudget.formattedRemainingAmount}">â‚¹0</span>
                                            </small>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="badge fs-6 p-3" 
                                                 th:style="'background-color: ' + ${currentBudget.budgetStatusColor}"
                                                 th:text="${currentBudget.budgetStatus}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-chart-pie me-2"></i>Category Spending
                                    </h5>
                                    <div class="chart-container">
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-chart-line me-2"></i>Monthly Trend
                                    </h5>
                                    <div class="chart-container">
                                        <canvas id="trendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity & Badges -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-clock me-2"></i>Recent Expenses
                                    </h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Description</th>
                                                    <th>Category</th>
                                                    <th>Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="expense : ${recentExpenses}">
                                                    <td th:text="${#temporals.format(expense.expenseDate, 'MMM dd')}"></td>
                                                    <td th:text="${expense.description}"></td>
                                                    <td>
                                                        <span th:text="${expense.categoryIcon}"></span>
                                                        <span th:text="${expense.category.displayName}"></span>
                                                    </td>
                                                    <td class="fw-bold" th:text="${expense.formattedAmount}"></td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(recentExpenses)}">
                                                    <td colspan="4" class="text-center text-muted">
                                                        No recent expenses. <a href="/user/expenses">Add your first expense</a>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card dashboard-card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-trophy me-2"></i>Recent Badges
                                    </h5>
                                    <div th:if="${#lists.isEmpty(recentBadges)}" class="text-center text-muted">
                                        <i class="fas fa-medal fa-3x mb-3 opacity-50"></i>
                                        <p>No badges earned yet!</p>
                                        <a href="/user/badges" class="btn btn-outline-primary btn-sm">
                                            View All Badges
                                        </a>
                                    </div>
                                    <div th:if="${!#lists.isEmpty(recentBadges)}">
                                        <div th:each="badge : ${recentBadges}" class="badge-card mb-2">
                                            <div th:text="${badge.badgeIcon}" class="fs-4"></div>
                                            <div class="fw-bold" th:text="${badge.badgeName}"></div>
                                            <small th:text="${badge.badgeLevel} + ' â€¢ ' + ${badge.badgePoints} + ' pts'"></small>
                                        </div>
                                        <div class="text-center mt-3">
                                            <a href="/user/badges" class="btn btn-outline-primary btn-sm">
                                                View All Badges
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        // Category Chart
        const categoryData = /*[[${categorySpending}]]*/ {};
        const categoryLabels = Object.keys(categoryData).map(key => key.replace('_', ' '));
        const categoryValues = Object.values(categoryData);
        
        if (categoryValues.length > 0) {
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryValues,
                        backgroundColor: [
                            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                            '#DDA0DD', '#98D8C8', '#F7DC6F', '#82E0AA', '#AED6F1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Trend Chart
        const trendData = /*[[${monthlyTrend}]]*/ {};
        const trendLabels = Object.keys(trendData);
        const trendValues = Object.values(trendData);
        
        if (trendValues.length > 0) {
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: trendValues,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>